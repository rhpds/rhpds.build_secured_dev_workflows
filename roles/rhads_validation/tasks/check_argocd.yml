---
- name: Initialize ArgoCD validation
  ansible.builtin.set_fact:
    argocd_validation:
      status: "healthy"
      instances: []
      total_healthy: 0
      total_degraded: 0
      total_failed: 0

- name: Check ArgoCD instances
  ansible.builtin.include_tasks: check_argocd_instance.yml
  loop: "{{ rhpds_build_secured_dev_workflows_rhads_validation_argocd_namespaces }}"
  loop_control:
    loop_var: argocd_namespace

- name: Determine overall ArgoCD health
  ansible.builtin.set_fact:
    argocd_validation: "{{ argocd_validation | combine({
      'status': 'failed' if argocd_validation.total_failed > 0
                else 'degraded' if argocd_validation.total_degraded > 0
                else 'healthy'
    }) }}"

- name: Update overall validation results for ArgoCD
  ansible.builtin.set_fact:
    rhads_validation_results: "{{ rhads_validation_results | combine({
      'components': rhads_validation_results.components | combine({
        'argocd': argocd_validation
      }),
      'summary': {
        'total_components': rhads_validation_results.summary.total_components + argocd_validation.instances | length,
        'healthy': rhads_validation_results.summary.healthy + argocd_validation.total_healthy,
        'degraded': rhads_validation_results.summary.degraded + argocd_validation.total_degraded,
        'failed': rhads_validation_results.summary.failed + argocd_validation.total_failed
      }
    }) }}"
