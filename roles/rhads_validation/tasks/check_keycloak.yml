---
- name: Get Keycloak pods in tssc-keycloak
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Pod
    namespace: tssc-keycloak
  register: r_keycloak_tssc_pods
  ignore_errors: true

- name: Get Keycloak pods in keycloak namespace
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Pod
    namespace: keycloak
  register: r_keycloak_tpa_pods
  ignore_errors: true

- name: Get Keycloak routes in tssc-keycloak
  kubernetes.core.k8s_info:
    api_version: route.openshift.io/v1
    kind: Route
    namespace: tssc-keycloak
  register: r_keycloak_tssc_routes
  ignore_errors: true

- name: Get Keycloak routes in keycloak namespace
  kubernetes.core.k8s_info:
    api_version: route.openshift.io/v1
    kind: Route
    namespace: keycloak
  register: r_keycloak_tpa_routes
  ignore_errors: true

- name: Test tssc-keycloak route accessibility (with retry for 5 minutes)
  ansible.builtin.uri:
    url: "https://{{ r_keycloak_tssc_routes.resources[0].spec.host }}"
    method: GET
    validate_certs: false
    status_code: [200, 301, 302, 303, 307]
    timeout: 10
  register: r_keycloak_tssc_http_check
  retries: 30  # 5 minutes / 10 seconds = 30 retries
  delay: 10    # Wait 10 seconds between retries
  until: r_keycloak_tssc_http_check is success
  ignore_errors: true
  when: r_keycloak_tssc_routes.resources | length > 0

- name: Test keycloak route accessibility (with retry for 5 minutes)
  ansible.builtin.uri:
    url: "https://{{ r_keycloak_tpa_routes.resources[0].spec.host }}"
    method: GET
    validate_certs: false
    status_code: [200, 301, 302, 303, 307]
    timeout: 10
  register: r_keycloak_tpa_http_check
  retries: 30  # 5 minutes / 10 seconds = 30 retries
  delay: 10    # Wait 10 seconds between retries
  until: r_keycloak_tpa_http_check is success
  ignore_errors: true
  when: r_keycloak_tpa_routes.resources | length > 0

- name: Evaluate Keycloak health
  ansible.builtin.set_fact:
    keycloak_status: |-
      {%- if r_keycloak_tssc_pods.resources | selectattr('status.phase', 'equalto', 'Running') | list | length == 0 or r_keycloak_tpa_pods.resources | selectattr('status.phase', 'equalto', 'Running') | list | length == 0 -%}
      unhealthy
      {%- elif (r_keycloak_tssc_http_check is defined and not r_keycloak_tssc_http_check.skipped | default(false) and r_keycloak_tssc_http_check.failed) or (r_keycloak_tpa_http_check is defined and not r_keycloak_tpa_http_check.skipped | default(false) and r_keycloak_tpa_http_check.failed) -%}
      not-accessible
      {%- else -%}
      healthy
      {%- endif -%}

- name: Create Keycloak validation result
  ansible.builtin.set_fact:
    keycloak_validation:
      status: "{{ keycloak_status }}"
      tssc_keycloak_pods: "{{ r_keycloak_tssc_pods.resources | length }}"
      tssc_keycloak_running: "{{ r_keycloak_tssc_pods.resources | selectattr('status.phase', 'equalto', 'Running') | list | length }}"
      tssc_keycloak_route: "{{ r_keycloak_tssc_routes.resources[0].spec.host if r_keycloak_tssc_routes.resources | length > 0 else 'N/A' }}"
      tssc_keycloak_accessible: "{{ not r_keycloak_tssc_http_check.failed if (r_keycloak_tssc_http_check is defined and not r_keycloak_tssc_http_check.skipped | default(false)) else false }}"
      tpa_keycloak_pods: "{{ r_keycloak_tpa_pods.resources | length }}"
      tpa_keycloak_running: "{{ r_keycloak_tpa_pods.resources | selectattr('status.phase', 'equalto', 'Running') | list | length }}"
      tpa_keycloak_route: "{{ r_keycloak_tpa_routes.resources[0].spec.host if r_keycloak_tpa_routes.resources | length > 0 else 'N/A' }}"
      tpa_keycloak_accessible: "{{ not r_keycloak_tpa_http_check.failed if (r_keycloak_tpa_http_check is defined and not r_keycloak_tpa_http_check.skipped | default(false)) else false }}"

- name: Add issue if Keycloak unhealthy
  when: keycloak_status != 'healthy'
  ansible.builtin.set_fact:
    rhads_validation_results: "{{ rhads_validation_results | combine({
      'issues': rhads_validation_results.issues + [
        'Keycloak is ' ~ keycloak_status
      ]
    }) }}"

- name: Update overall validation results for Keycloak
  ansible.builtin.set_fact:
    rhads_validation_results: "{{ rhads_validation_results | combine({
      'components': rhads_validation_results.components | combine({
        'keycloak': keycloak_validation
      }),
      'summary': {
        'total_components': rhads_validation_results.summary.total_components + 1,
        'healthy': rhads_validation_results.summary.healthy + (1 if keycloak_status == 'healthy' else 0),
        'degraded': rhads_validation_results.summary.degraded,
        'failed': rhads_validation_results.summary.failed + (1 if keycloak_status != 'healthy' else 0)
      }
    }) }}"
