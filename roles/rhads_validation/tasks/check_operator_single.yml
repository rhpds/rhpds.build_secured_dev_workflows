---
# Check a single operator
# Expected variable: operator (dict with name and namespace)

- name: Get operator CSV in {{ operator.namespace }}
  kubernetes.core.k8s_info:
    api_version: operators.coreos.com/v1alpha1
    kind: ClusterServiceVersion
    namespace: "{{ operator.namespace }}"
  register: r_operator_csv
  ignore_errors: true

- name: Find CSV for {{ operator.name }}
  ansible.builtin.set_fact:
    operator_csv: "{{ r_operator_csv.resources | selectattr('metadata.name', 'search', operator.name) | list | first | default({}) }}"
  when: r_operator_csv.resources | length > 0

- name: Get all pods in {{ operator.namespace }}
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Pod
    namespace: "{{ operator.namespace }}"
  register: r_operator_pods
  ignore_errors: true

- name: Evaluate operator health status
  ansible.builtin.set_fact:
    operator_status: |-
      {%- if operator_csv is not defined or operator_csv == {} -%}
      missing
      {%- elif operator_csv.status.phase | default('') != 'Succeeded' -%}
      failed
      {%- elif operator_csv.status.phase | default('') == 'Succeeded' -%}
      healthy
      {%- else -%}
      unknown
      {%- endif -%}

- name: Update operators validation tracking
  ansible.builtin.set_fact:
    operators_validation: "{{ operators_validation | combine({
      'checked': operators_validation.checked + 1,
      'healthy': operators_validation.healthy + (1 if operator_status == 'healthy' else 0),
      'degraded': operators_validation.degraded + (1 if operator_status == 'unknown' else 0),
      'failed': operators_validation.failed + (1 if operator_status in ['missing', 'failed'] else 0),
      'details': operators_validation.details + [{
        'name': operator.name,
        'namespace': operator.namespace,
        'status': operator_status,
        'csv_phase': operator_csv.status.phase | default('N/A') if operator_csv is defined and operator_csv != {} else 'N/A',
        'pod_count': r_operator_pods.resources | length,
        'csv_name': operator_csv.metadata.name | default('N/A') if operator_csv is defined and operator_csv != {} else 'N/A'
      }]
    }) }}"

- name: Add issue if operator unhealthy
  when: operator_status != 'healthy'
  ansible.builtin.set_fact:
    rhads_validation_results: "{{ rhads_validation_results | combine({
      'issues': rhads_validation_results.issues + [
        'Operator ' ~ operator.name ~ ' in namespace ' ~ operator.namespace ~ ' is ' ~ operator_status
      ]
    }) }}"
