---
- name: Get Tekton controller pods
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Pod
    namespace: openshift-pipelines
    label_selectors:
      - "app=tekton-pipelines-controller"
  register: r_tekton_controller
  ignore_errors: true

- name: Evaluate Pipelines health
  ansible.builtin.set_fact:
    pipelines_status: |-
      {%- if r_tekton_controller.resources | length == 0 -%}
      missing
      {%- elif r_tekton_controller.resources | selectattr('status.phase', 'equalto', 'Running') | list | length == 0 -%}
      unavailable
      {%- else -%}
      healthy
      {%- endif -%}

- name: Create Pipelines validation result
  ansible.builtin.set_fact:
    pipelines_validation:
      status: "{{ pipelines_status }}"
      controller_pods: "{{ r_tekton_controller.resources | length }}"
      controller_running: "{{ r_tekton_controller.resources | selectattr('status.phase', 'equalto', 'Running') | list | length }}"

- name: Add issue if Pipelines unhealthy
  when: pipelines_status != 'healthy'
  ansible.builtin.set_fact:
    rhads_validation_results: "{{ rhads_validation_results | combine({
      'issues': rhads_validation_results.issues + [
        'OpenShift Pipelines is ' ~ pipelines_status
      ]
    }) }}"

- name: Update overall validation results for Pipelines
  ansible.builtin.set_fact:
    rhads_validation_results: "{{ rhads_validation_results | combine({
      'components': rhads_validation_results.components | combine({
        'pipelines': pipelines_validation
      }),
      'summary': {
        'total_components': rhads_validation_results.summary.total_components + 1,
        'healthy': rhads_validation_results.summary.healthy + (1 if pipelines_status == 'healthy' else 0),
        'degraded': rhads_validation_results.summary.degraded,
        'failed': rhads_validation_results.summary.failed + (1 if pipelines_status != 'healthy' else 0)
      }
    }) }}"
