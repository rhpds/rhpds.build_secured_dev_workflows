---
- name: Retrieve Gitlab root private token
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Secret
    name: root-user-personal-token
    namespace: "{{ rhpds_build_secured_dev_workflows_developer_hub_gitlab_namespace }}"
  register: r_root_token
  retries: 120
  delay: 10
  until:
  - r_root_token is defined
  - r_root_token.resources is defined
  - r_root_token.resources | length > 0
  - r_root_token.resources[0] is defined
  - r_root_token.resources[0].data is defined
  - r_root_token.resources[0].data.token is defined
  - r_root_token.resources[0].data.token | length > 0

- name: Decode root token
  ansible.builtin.set_fact:
    _rhpds_build_secured_dev_workflows_developer_hub_gitlab_root_token: "{{ r_root_token.resources[0].data.token | b64decode }}"

- name: List Gitlab users
  ansible.builtin.uri:
    url: "https://{{ _rhpds_build_secured_dev_workflows_developer_hub_gitlab_host }}/api/v4/users?per_page=100"
    method: GET
    headers:
      PRIVATE-TOKEN: "{{ _rhpds_build_secured_dev_workflows_developer_hub_gitlab_root_token }}"
    validate_certs: false
    status_code: 200
  register: r_users

- name: Create development group
  ansible.builtin.uri:
    url: "https://{{ _rhpds_build_secured_dev_workflows_developer_hub_gitlab_host }}/api/v4/groups"
    method: POST
    body_format: form-urlencoded
    body:
      name: development
      path: development
      visibility: public
    headers:
      PRIVATE-TOKEN: "{{ _rhpds_build_secured_dev_workflows_developer_hub_gitlab_root_token }}"
    validate_certs: false
    status_code: 201
  register: r_group
  retries: 100
  delay: 5
  until: r_group.status == 201

- name: Add users to development group
  when: item.username.startswith('{{ rhpds_build_secured_dev_workflows_developer_hub_gitlab_user_base_name }}')
  ansible.builtin.uri:
    url: "https://{{ _rhpds_build_secured_dev_workflows_developer_hub_gitlab_host }}/api/v4/groups/{{ r_group.json.id }}/members"
    method: POST
    body_format: form-urlencoded
    body:
      user_id: "{{ item.id }}"
      access_level: 50
    headers:
      PRIVATE-TOKEN: "{{ _rhpds_build_secured_dev_workflows_developer_hub_gitlab_root_token }}"
    validate_certs: false
    status_code: 201
  register: r_group_user
  retries: 100
  delay: 5
  until: r_group_user.status == 201
  loop: "{{ r_users.json }}"

- name: Template out DH assets
  ansible.builtin.template:
    src: "{{ item }}.j2"
    dest: "/home/{{ student_name }}/lab-assets/{{ item }}"
  loop:
  - gitlab-auth-secret.yml.j2
  delegate_to: bastion