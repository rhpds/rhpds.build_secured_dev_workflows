---
- name: Get OpenShift Apps Domain
  ansible.builtin.set_fact:
    _rhpds_build_secured_dev_workflows_developer_hub_gitlab_host: "gitlab-{{
      rhpds_build_secured_dev_workflows_developer_hub_gitlab_namespace }}.{{
      openshift_cluster_ingress_domain }}"
    _rhpds_build_secured_dev_workflows_developer_hub_host: "backstage-{{
      rhpds_build_secured_dev_workflows_developer_hub_namespace }}.{{
      openshift_cluster_ingress_domain }}"
    _rhpds_build_secured_dev_workflows_developer_hub_devspaces_host: "devspaces.{{
      openshift_cluster_ingress_domain }}"
    _rhpds_build_secured_dev_workflows_developer_hub_quay_host: quay-{{ guid }}.{{
      openshift_cluster_ingress_domain }}
    _rhpds_build_secured_dev_workflows_developer_hub_argocd_host: janus-argocd.{{
      openshift_cluster_ingress_domain }}
    _rhpds_build_secured_dev_workflows_developer_hub_keycloak_host: sso.{{
      openshift_cluster_ingress_domain }}

- name: Retrieve Gitlab root private token
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Secret
    name: root-user-personal-token
    namespace: "{{ rhpds_build_secured_dev_workflows_developer_hub_gitlab_namespace }}"
  register: r_root_token
  retries: 120
  delay: 10
  until:
  - r_root_token is defined
  - r_root_token.resources is defined
  - r_root_token.resources | length > 0
  - r_root_token.resources[0] is defined
  - r_root_token.resources[0].data is defined
  - r_root_token.resources[0].data.token is defined
  - r_root_token.resources[0].data.token | length > 0

- name: Setup Gitlab
  ansible.builtin.include_tasks:
    file: ./setup_gitlab.yml

- name: Decode root token
  ansible.builtin.set_fact:
    _rhpds_build_secured_dev_workflows_developer_hub_gitlab_root_token: "{{ r_root_token.resources[0].data.token | b64decode }}"

- name: Setup Quay
  ansible.builtin.include_tasks:
    file: ./setup_quay.yml

- name: Setup Keycloak
  ansible.builtin.include_tasks:
    file: ./setup_keycloak.yml

- name: Setup Developer Hub
  ansible.builtin.include_tasks:
    file: ./setup_dh.yml